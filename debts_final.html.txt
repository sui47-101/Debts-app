<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¯ÙŠÙˆÙ† â€” Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root{
      --primary:#0d6efd;
      --bg:#f6f8fb;
      --card:#ffffff;
      --muted:#6c757d;
      --radius:12px;
    }
    body{ background:var(--bg); font-family: "Segoe UI", Tahoma, "Noto Naskh Arabic", sans-serif; padding:20px; }
    .app-shell{ max-width:1100px; margin:0 auto; }
    .topbar{ display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:12px; }
    .card-sum{ border-radius:10px; padding:12px; background:var(--card); box-shadow:0 6px 18px rgba(20,20,40,0.04); }
    .summary{ display:flex; gap:12px; flex-wrap:wrap; }
    .sum-item{ flex:1 1 200px; padding:10px; border-radius:8px; background:linear-gradient(180deg,#fff,#f7fbff); }
    .sum-title{ font-size:13px; color:var(--muted); }
    .sum-value{ font-size:20px; font-weight:700; margin-top:6px; }
    table.custom-table thead th{ background:linear-gradient(90deg,var(--primary),#5aa6ff); color:#fff; border:0; }
    tr.overdue td{ background:#fff0f0 !important; }
    tr.near td{ background:#fffaf0 !important; }
    .paid-row td{ text-decoration:line-through; color:#8b8b8b; opacity:0.9; }
    /* Ø²Ø± + Ø«Ø§Ø¨Øª Ø£Ø¹Ù„Ù‰ ÙŠÙ…ÙŠÙ† */
    .btn-add-fixed{
      position:fixed;
      top:18px;
      right:18px;
      z-index:1200;
      border-radius:50%;
      width:54px;
      height:54px;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 6px 18px rgba(0,0,0,0.12);
    }
    /* ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
    .login-shell{ max-width:420px; margin:60px auto; }
    @media (max-width:720px){
      .topbar{ flex-direction:column; align-items:stretch; }
      .summary{ flex-direction:column; }
      .btn-add-fixed{ width:48px; height:48px; top:12px; right:12px; }
    }
  </style>
</head>
<body>
  <!-- Ø²Ø± Ø§Ø¶Ø§ÙØ© Ø«Ø§Ø¨Øª -->
  <button id="globalAddBtn" class="btn btn-primary btn-add-fixed" title="Ø¥Ø¶Ø§ÙØ© Ø¯ÙŠÙ† Ø¬Ø¯ÙŠØ¯">
    <i class="bi bi-plus-lg" style="font-size:1.25rem;color:white"></i>
  </button>

  <!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <div id="loginView" class="login-shell">
    <div class="card p-4">
      <h4 class="mb-3">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</h4>
      <form id="loginForm">
        <div class="mb-2">
          <label class="form-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
          <input id="loginEmail" class="form-control" placeholder="example@domain.com" required>
        </div>
        <div class="mb-2">
          <label class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
          <input id="loginPassword" type="password" class="form-control" required>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-primary" type="submit">Ø¯Ø®ÙˆÙ„</button>
          <button id="demoAdmin" type="button" class="btn btn-outline-secondary">ØªØ¬Ø±Ø¨Ø© Admin</button>
          <button id="demoViewer" type="button" class="btn btn-outline-secondary">ØªØ¬Ø±Ø¨Ø© Viewer</button>
        </div>
        <div class="mt-3 text-muted" style="font-size:13px">
          Ø­Ø³Ø§Ø¨ Ø±Ø¦ÙŠØ³ÙŠ: <b>admin@debt.app</b> / admin123<br>
          Ø­Ø³Ø§Ø¨ Ø¹Ø±Ø¶ ÙÙ‚Ø·: <b>viewer@debt.app</b> / viewer123
        </div>
      </form>
    </div>
  </div>

  <!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->
  <div id="appView" class="app-shell" style="display:none;">
    <div class="topbar">
      <div>
        <h3 class="mb-0">ğŸ“‹ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¯ÙŠÙˆÙ†</h3>
        <div id="welcomeText" class="text-muted">â€”</div>
      </div>
      <div class="d-flex gap-2 align-items-center">
        <div class="me-2 text-muted" id="roleBadge"></div>
        <button id="manageUsersBtn" class="btn btn-sm btn-outline-secondary" style="display:none;"><i class="bi bi-people"></i> Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</button>
        <button id="logoutBtn" class="btn btn-sm btn-danger"><i class="bi bi-box-arrow-left"></i> Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>

    <div class="card-sum mb-3">
      <div class="summary">
        <div class="sum-item">
          <div class="sum-title">Ù…Ø¬Ù…ÙˆØ¹ ÙƒÙ„ Ø§Ù„Ø¯ÙŠÙˆÙ†</div>
          <div class="sum-value" id="sumAll">0</div>
        </div>
        <div class="sum-item">
          <div class="sum-title">Ø§Ù„Ù…Ø¯ÙÙˆØ¹</div>
          <div class="sum-value text-success" id="sumPaid">0</div>
        </div>
        <div class="sum-item">
          <div class="sum-title">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
          <div class="sum-value text-danger" id="sumUnpaid">0</div>
        </div>
        <div class="sum-item">
          <div class="sum-title">Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©</div>
          <div class="sum-value text-warning" id="sumOverdue">0</div>
        </div>
      </div>
    </div>

    <!-- Controls -->
    <div class="d-flex gap-2 mb-2">
      <input id="searchInput" class="form-control form-control-sm" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ† Ø£Ùˆ Ù…Ù„Ø§Ø­Ø¸Ø©">
      <select id="filterSelect" class="form-select form-select-sm" style="width:170px;">
        <option value="all">Ø§Ù„ÙƒÙ„</option>
        <option value="unpaid">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</option>
        <option value="paid">Ù…Ø¯ÙÙˆØ¹</option>
        <option value="overdue">Ù…ØªØ£Ø®Ø±Ø©</option>
      </select>
      <button id="exportCsvBtn" class="btn btn-sm btn-outline-secondary"><i class="bi bi-file-earmark-spreadsheet"></i> ØªØµØ¯ÙŠØ± CSV</button>
    </div>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø²Ø¨Ø§Ø¦Ù† (Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø¯ÙŠÙˆÙ† Ù„ÙƒÙ„ Ø²Ø¨ÙˆÙ†) -->
    <div class="table-responsive">
      <table class="table table-hover custom-table align-middle">
        <thead>
          <tr>
            <th>Ø§Ù„Ø²Ø¨ÙˆÙ†</th>
            <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙŠÙˆÙ†</th>
            <th>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø²Ø¨ÙˆÙ†</th>
            <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ (ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹)</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th style="width:200px">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody id="customersBody">
          <!-- ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¨Ø§Ù„Ù€ JS -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø¯ÙŠÙ† -->
  <div class="modal fade" id="debtModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <form id="debtForm" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="debtModalTitle">Ø¥Ø¶Ø§ÙØ© Ø¯ÙŠÙ† Ø¬Ø¯ÙŠØ¯</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2">
            <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†</label>
            <input id="debtCustomer" class="form-control" required>
          </div>
          <div class="mb-2">
            <label class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº</label>
            <input id="debtAmount" type="number" step="0.01" class="form-control" required>
          </div>
          <div class="mb-2">
            <label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</label>
            <input id="debtDue" type="date" class="form-control" required>
          </div>
          <div class="mb-2">
            <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <textarea id="debtNote" class="form-control" rows="2"></textarea>
          </div>
          <input type="hidden" id="editingDebtId" value="">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
          <button type="submit" class="btn btn-primary">Ø­ÙØ¸</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Ù„Ù€ Admin) -->
  <div class="modal fade" id="usersModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="usersList" class="mb-3"></div>
          <hr>
          <h6>Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</h6>
          <div class="mb-2">
            <input id="newUserEmail" class="form-control" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
          </div>
          <div class="mb-2">
            <input id="newUserPass" class="form-control" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
          </div>
          <div class="mb-2">
            <select id="newUserRole" class="form-select">
              <option value="viewer">Ø¹Ø±Ø¶ ÙÙ‚Ø· (Viewer)</option>
              <option value="admin">Ù…Ø¯ÙŠØ± (Admin)</option>
            </select>
          </div>
          <button id="addUserBtn" class="btn btn-sm btn-primary">Ø¥Ø¶Ø§ÙØ©</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    /* ---------- Ø¨ÙŠØ§Ù†Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (Ù„Ùˆ Ù…Ø§ Ù…ÙˆØ¬ÙˆØ¯Ø©) ---------- */
    const USERS_KEY = 'debt_users_v1';
    const DEBTS_KEY = 'debts_v_final';
    const SESSION_KEY = 'debt_session';

    function defaultInit(){
      if(!localStorage.getItem(USERS_KEY)){
        const defaults = [
          {email:'admin@debt.app', password:'admin123', role:'admin', name:'Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„'},
          {email:'viewer@debt.app', password:'viewer123', role:'viewer', name:'Ø¹Ø§Ø±Ø¶'}
        ];
        localStorage.setItem(USERS_KEY, JSON.stringify(defaults));
      }
      if(!localStorage.getItem(DEBTS_KEY)){
        // Ø¹ÙŠÙ†Ø© Ø¨ÙŠØ§Ù†Ø§Øª ØµØºÙŠØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        const sample = [
          {id:Date.now()+1, customer:'Ø£Ø­Ù…Ø¯', amount:150, dueDate: addDaysISO(-2), note:'Ø¯ÙØ¹Ø© Ø¬Ø²Ø¦ÙŠØ©', paid:false, created: new Date().toISOString()},
          {id:Date.now()+2, customer:'Ø³Ø¹ÙŠØ¯', amount:300, dueDate: addDaysISO(4), note:'Ø¯ÙŠÙ† Ø¬Ø¯ÙŠØ¯', paid:false, created: new Date().toISOString()},
          {id:Date.now()+3, customer:'Ø£Ø­Ù…Ø¯', amount:100, dueDate: addDaysISO(10), note:'Ø¨Ø§Ù‚ÙŠ', paid:false, created: new Date().toISOString()},
          {id:Date.now()+4, customer:'Ù…Ù†Ù‰', amount:200, dueDate: addDaysISO(-6), note:'Ù…ØªØ£Ø®Ø±', paid:false, created: new Date().toISOString()}
        ];
        localStorage.setItem(DEBTS_KEY, JSON.stringify(sample));
      }
    }

    function addDaysISO(days){ const d=new Date(); d.setDate(d.getDate()+days); return d.toISOString().slice(0,10); }

    defaultInit();

    /* ---------- Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ---------- */
    function loadUsers(){ return JSON.parse(localStorage.getItem(USERS_KEY) || '[]'); }
    function saveUsers(u){ localStorage.setItem(USERS_KEY, JSON.stringify(u)); }
    function loadDebts(){ return JSON.parse(localStorage.getItem(DEBTS_KEY) || '[]'); }
    function saveDebts(arr){ localStorage.setItem(DEBTS_KEY, JSON.stringify(arr)); }
    function setSession(user){ sessionStorage.setItem(SESSION_KEY, JSON.stringify(user)); }
    function clearSession(){ sessionStorage.removeItem(SESSION_KEY); }
    function getSession(){ return JSON.parse(sessionStorage.getItem(SESSION_KEY) || 'null'); }
    function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }

    /* ---------- Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙØ­Ø© ---------- */
    const loginView = document.getElementById('loginView');
    const appView = document.getElementById('appView');
    const loginForm = document.getElementById('loginForm');
    const demoAdmin = document.getElementById('demoAdmin');
    const demoViewer = document.getElementById('demoViewer');
    const logoutBtn = document.getElementById('logoutBtn');
    const welcomeText = document.getElementById('welcomeText');
    const roleBadge = document.getElementById('roleBadge');
    const manageUsersBtn = document.getElementById('manageUsersBtn');

    const globalAddBtn = document.getElementById('globalAddBtn');
    const debtModalEl = document.getElementById('debtModal');
    const debtModal = new bootstrap.Modal(debtModalEl);
    const debtForm = document.getElementById('debtForm');
    const debtModalTitle = document.getElementById('debtModalTitle');
    const editingDebtId = document.getElementById('editingDebtId');

    const customersBody = document.getElementById('customersBody');
    const sumAll = document.getElementById('sumAll');
    const sumPaid = document.getElementById('sumPaid');
    const sumUnpaid = document.getElementById('sumUnpaid');
    const sumOverdue = document.getElementById('sumOverdue');
    const searchInput = document.getElementById('searchInput');
    const filterSelect = document.getElementById('filterSelect');
    const exportCsvBtn = document.getElementById('exportCsvBtn');

    const usersModal = new bootstrap.Modal(document.getElementById('usersModal'));
    const manageUsersBtnEl = document.getElementById('manageUsersBtn');
    const usersListDiv = document.getElementById('usersList');
    const newUserEmail = document.getElementById('newUserEmail');
    const newUserPass = document.getElementById('newUserPass');
    const newUserRole = document.getElementById('newUserRole');
    const addUserBtn = document.getElementById('addUserBtn');

    /* ---------- ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ---------- */
    loginForm.addEventListener('submit', e=>{
      e.preventDefault();
      const email = document.getElementById('loginEmail').value.trim();
      const pass = document.getElementById('loginPassword').value;
      const users = loadUsers();
      const u = users.find(x=>x.email.toLowerCase()===email.toLowerCase() && x.password===pass);
      if(!u){ alert('Ø®Ø·Ø£ Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±'); return; }
      setSession({email:u.email, role:u.role, name:u.name || u.email});
      showApp();
    });

    demoAdmin.addEventListener('click', ()=>{
      document.getElementById('loginEmail').value = 'admin@debt.app';
      document.getElementById('loginPassword').value = 'admin123';
    });
    demoViewer.addEventListener('click', ()=>{
      document.getElementById('loginEmail').value = 'viewer@debt.app';
      document.getElementById('loginPassword').value = 'viewer123';
    });

    logoutBtn.addEventListener('click', ()=>{
      clearSession();
      location.reload();
    });

    function showApp(){
      const s = getSession();
      if(!s){ loginView.style.display='block'; appView.style.display='none'; return; }
      loginView.style.display='none'; appView.style.display='block';
      welcomeText.innerHTML = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ <b>${escapeHtml(s.name || s.email)}</b>`;
      roleBadge.innerHTML = s.role === 'admin' ? '<span class="badge bg-primary">Admin</span>' : '<span class="badge bg-secondary">Viewer</span>';
      // ØµÙ„Ø§Ø­ÙŠØ§Øª
      if(s.role === 'admin'){ manageUsersBtn.style.display='inline-block'; manageUsersBtn.onclick = ()=> usersModal.show(); }
      else { manageUsersBtn.style.display='none'; }
      // Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© ÙŠØ¸Ù‡Ø± Ø£Ùˆ ÙŠØ®ÙÙŠ
      globalAddBtn.style.display = s.role === 'viewer' ? 'none' : 'flex';
      renderAll();
      renderUsersList();
    }

    /* ---------- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Admin) ---------- */
    function renderUsersList(){
      const users = loadUsers();
      usersListDiv.innerHTML = '';
      users.forEach((u,i)=>{
        const div = document.createElement('div');
        div.className = 'd-flex align-items-center justify-content-between mb-2';
        div.innerHTML = `<div><b>${escapeHtml(u.email)}</b> â€” <small class="text-muted">${u.role}</small></div>
          <div>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${i})">Ø­Ø°Ù</button>
            <button class="btn btn-sm btn-outline-primary ms-1" onclick="resetPass(${i})">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</button>
          </div>`;
        usersListDiv.appendChild(div);
      });
    }
    window.deleteUser = function(i){
      if(!confirm('ØªØ±ÙŠØ¯ ØªØ­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ')) return;
      const users = loadUsers();
      users.splice(i,1);
      saveUsers(users);
      renderUsersList();
    }
    window.resetPass = function(i){
      const users = loadUsers();
      const newPass = prompt('Ø§Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…:', users[i].password);
      if(newPass===null) return;
      users[i].password = newPass;
      saveUsers(users);
      alert('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«');
      renderUsersList();
    }
    addUserBtn.addEventListener('click', ()=>{
      const em = newUserEmail.value.trim();
      const pw = newUserPass.value.trim();
      const role = newUserRole.value;
      if(!em || !pw){ alert('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„'); return; }
      const users = loadUsers();
      if(users.find(x=>x.email.toLowerCase()===em.toLowerCase())){ alert('Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„'); return; }
      users.push({email:em, password:pw, role:role, name:em.split('@')[0]});
      saveUsers(users);
      newUserEmail.value=''; newUserPass.value=''; newUserRole.value='viewer';
      renderUsersList();
      alert('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©');
    });

    /* ---------- Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¯ÙŠÙˆÙ† ---------- */
    globalAddBtn.addEventListener('click', ()=> openAddModal());
    function openAddModal(prefillCustomer=''){
      editingDebtId.value = '';
      debtModalTitle.textContent = 'Ø¥Ø¶Ø§ÙØ© Ø¯ÙŠÙ† Ø¬Ø¯ÙŠØ¯';
      document.getElementById('debtCustomer').value = prefillCustomer;
      document.getElementById('debtAmount').value = '';
      document.getElementById('debtDue').value = new Date().toISOString().slice(0,10);
      document.getElementById('debtNote').value = '';
      debtModal.show();
    }

    debtForm.addEventListener('submit', e=>{
      e.preventDefault();
      const id = editingDebtId.value;
      const customer = document.getElementById('debtCustomer').value.trim();
      const amount = Number(document.getElementById('debtAmount').value) || 0;
      const due = document.getElementById('debtDue').value;
      const note = document.getElementById('debtNote').value.trim();
      if(!customer || !due || amount<=0){ alert('Ø§ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­'); return; }
      const debts = loadDebts();
      if(id){
        // ØªØ¹Ø¯ÙŠÙ„
        const idx = debts.findIndex(x=>x.id==id);
        if(idx>=0){
          debts[idx].customer = customer;
          debts[idx].amount = amount;
          debts[idx].dueDate = due;
          debts[idx].note = note;
        }
      } else {
        debts.push({id: Date.now().toString(), customer, amount, dueDate: due, note, paid:false, created: new Date().toISOString()});
      }
      saveDebts(debts);
      debtModal.hide();
      renderAll();
    });

    /* ---------- Ø¹Ø±Ø¶ Ø§Ù„Ø²Ø¨Ø§Ø¦Ù† ÙˆØ¬Ù…Ø¹ Ø§Ù„Ø¯ÙŠÙˆÙ† ---------- */
    function renderAll(){
      const debts = loadDebts();
      const now = new Date();
      // ØªØ¬Ù…ÙŠØ¹ Ø­Ø³Ø¨ Ø§Ù„Ø²Ø¨ÙˆÙ†
      const map = {};
      debts.forEach(d=>{
        const key = (d.customer||'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ').trim();
        if(!map[key]) map[key] = {customer:key, debts:[], total:0, unpaid:0, paid:0, overdue:0};
        map[key].debts.push(d);
        map[key].total += Number(d.amount||0);
        if(d.paid) map[key].paid += Number(d.amount||0);
        else map[key].unpaid += Number(d.amount||0);
        const due = new Date((d.dueDate||'') + 'T00:00:00');
        if(!d.paid && (due < new Date(now.toDateString()))) map[key].overdue += Number(d.amount||0);
      });
      // ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ø®Ø§Ù†Ø© Ù…Ø±ØªØ¨Ø©
      const customers = Object.values(map).sort((a,b)=> b.total - a.total);
      // Ø§Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ø§Ù…Ø©
      let totAll=0, totPaid=0, totUn=0, totOver=0;
      debts.forEach(d=>{
        totAll += Number(d.amount||0);
        if(d.paid) totPaid += Number(d.amount||0); else totUn += Number(d.amount||0);
        const due = new Date((d.dueDate||'') + 'T00:00:00');
        if(!d.paid && (due < new Date(now.toDateString()))) totOver += Number(d.amount||0);
      });
      sumAll.textContent = totAll.toLocaleString();
      sumPaid.textContent = totPaid.toLocaleString();
      sumUnpaid.textContent = totUn.toLocaleString();
      sumOverdue.textContent = totOver.toLocaleString();

      // ÙÙ„ØªØ±Ø© + Ø¨Ø­Ø«
      const q = (searchInput.value||'').trim().toLowerCase();
      const f = filterSelect.value;

      customersBody.innerHTML = '';
      customers.forEach((c,ci)=>{
        const matchesQ = c.customer.toLowerCase().includes(q) || c.debts.some(dd=> (dd.note||'').toLowerCase().includes(q) );
        if(!matchesQ) return;
        if(f==='overdue' && c.overdue<=0) return;
        if(f==='paid' && c.unpaid>0) return;
        if(f==='unpaid' && c.unpaid==0) return;

        const tr = document.createElement('tr');
        // status: Ø¥Ø°Ø§ ÙƒÙ„ Ø¯ÙŠÙˆÙ† Ø§Ù„Ø²Ø¨ÙˆÙ† Ù…Ø¯ÙÙˆØ¹Ø© -> Ù…Ø¯ÙÙˆØ¹
        let statusHtml = c.unpaid==0 ? '<span class="badge bg-success">Ù…Ø¯ÙÙˆØ¹</span>' : '<span class="badge bg-warning text-dark">Ù…Ø³Ø¬Ù„ Ø¯ÙŠÙˆÙ†</span>';
        tr.innerHTML = `
          <td><a href="#" class="customer-toggle" data-idx="${ci}">${escapeHtml(c.customer)}</a></td>
          <td>${c.debts.length}</td>
          <td>${c.total.toLocaleString()}</td>
          <td>${c.unpaid.toLocaleString()}</td>
          <td>${statusHtml}</td>
          <td>
            ${getSession().role==='admin' ? `<button class="btn btn-sm btn-outline-success me-1" onclick="openAddForCustomer('${escapeForAttr(c.customer)}')"><i class="bi bi-plus"></i> Ø¯ÙŠÙ†</button>` : ''}
            <button class="btn btn-sm btn-outline-primary me-1" onclick="toggleDetails(${ci})"><i class="bi bi-eye"></i> Ø¹Ø±Ø¶</button>
            ${getSession().role==='admin' ? `<button class="btn btn-sm btn-outline-danger" onclick="deleteAllCustomer('${escapeForAttr(c.customer)}')"><i class="bi bi-trash"></i> Ø­Ø°Ù ÙƒÙ„</button>` : ''}
          </td>
        `;
        customersBody.appendChild(tr);

        // ØµÙ Ø§Ù„ØªÙØ§ØµÙŠÙ„ (Ù…Ø®ÙÙŠ)
        const detailTr = document.createElement('tr');
        detailTr.className = 'detail-row';
        detailTr.style.display = 'none';
        const td = document.createElement('td');
        td.colSpan = 6;
        // Ø¬Ø¯ÙˆÙ„ Ø¯Ø§Ø®Ù„ÙŠ Ù„Ù„Ø¯ÙŠÙˆÙ†
        const innerTable = document.createElement('table');
        innerTable.className = 'table table-sm mb-0';
        innerTable.innerHTML = `<thead><tr><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</th><th>Ù…Ù„Ø§Ø­Ø¸Ø©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody></tbody>`;
        const innerBody = innerTable.querySelector('tbody');
        c.debts.forEach(d=>{
          const r = document.createElement('tr');
          // Ø­Ø§Ù„Ø© Ø§Ù„Ù„ÙˆÙ†
          const due = new Date((d.dueDate||'')+'T00:00:00');
          if(!d.paid){
            const nowd = new Date();
            if(due < new Date(nowd.toDateString())) r.classList.add('table-danger');
            else {
              const daysLeft = Math.ceil((due - nowd)/(1000*60*60*24));
              if(daysLeft<=3) r.classList.add('table-warning');
            }
          } else r.classList.add('paid-row');

          r.innerHTML = `
            <td>${Number(d.amount).toLocaleString()}</td>
            <td>${d.dueDate}</td>
            <td title="${escapeHtml(d.note||'')}">${escapeHtml(d.note||'')}</td>
            <td>${d.paid ? '<span class="badge bg-success">Ù…Ø¯ÙÙˆØ¹</span>' : '<span class="badge bg-warning text-dark">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</span>'}</td>
            <td>
              ${getSession().role==='admin' && !d.paid ? `<button class="btn btn-sm btn-outline-success me-1" onclick="markPaid('${d.id}')"><i class="bi bi-check2"></i></button>` : ''}
              ${getSession().role==='admin' ? `<button class="btn btn-sm btn-outline-primary me-1" onclick="editDebt('${d.id}')"><i class="bi bi-pencil"></i></button>` : ''}
              ${getSession().role==='admin' ? `<button class="btn btn-sm btn-outline-danger" onclick="deleteDebt('${d.id}')"><i class="bi bi-trash"></i></button>` : ''}
            </td>
          `;
          innerBody.appendChild(r);
        });

        td.appendChild(innerTable);
        detailTr.appendChild(td);
        customersBody.appendChild(detailTr);
      });
    }

    function escapeForAttr(s){ return (s||'').replace(/'/g,"\\'").replace(/"/g,'&quot;'); }

    // ÙØªØ­ Ø¥Ø¶Ø§ÙØ© Ø¯ÙŠÙ† Ù„Ù„Ø²Ø¨ÙˆÙ† Ù…Ø¨Ø§Ø´Ø±Ø©
    window.openAddForCustomer = function(name){
      openAddModal(name);
    }

    // ØªØ¨Ø¯ÙŠÙ„ Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„
    function toggleDetails(ci){
      const rows = document.querySelectorAll('#customersBody .detail-row');
      // Ù†Ø¹Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„ØµÙ Ø§Ù„Ù…Ø±ØªØ¨Ø· Ø¨Ø§Ù„Ù€ index: Ø¨Ù…Ø§ Ø£Ù†Ù†Ø§ Ù†Ø¹ÙŠØ¯ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙƒÙ„ Ù…Ø±Ø©ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØ±ØªÙŠØ¨
      const allDetailRows = Array.from(rows);
      if(!allDetailRows[ci]) return;
      allDetailRows.forEach(r=> r.style.display = 'none');
      allDetailRows[ci].style.display = allDetailRows[ci].style.display === 'none' ? '' : 'none';
    }
    window.toggleDetails = toggleDetails;

    // Ø­Ø°Ù ÙƒÙ„ Ø¯ÙŠÙˆÙ† Ø²Ø¨ÙˆÙ†
    window.deleteAllCustomer = function(customer){
      if(!confirm('ØªØ­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¯ÙŠÙˆÙ† Ù„Ù‡Ø°Ø§ Ø§Ù„Ø²Ø¨ÙˆÙ†ØŸ')) return;
      let debts = loadDebts();
      debts = debts.filter(d=> d.customer !== customer);
      saveDebts(debts);
      renderAll();
    }

    // Ø¹Ù„Ø§Ù…Ø§Øª: ØªØ³Ø¯ÙŠØ¯ØŒ Ø­Ø°ÙØŒ ØªØ¹Ø¯ÙŠÙ„
    window.markPaid = function(id){
      const debts = loadDebts();
      const idx = debts.findIndex(x=>x.id==id);
      if(idx<0) return;
      debts[idx].paid = true;
      debts[idx].paidAt = new Date().toISOString();
      saveDebts(debts);
      renderAll();
    }
    window.deleteDebt = function(id){
      if(!confirm('ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø¯ÙŠÙ†ØŸ')) return;
      let debts = loadDebts();
      debts = debts.filter(x=> x.id!=id);
      saveDebts(debts);
      renderAll();
    }
    window.editDebt = function(id){
      const debts = loadDebts();
      const d = debts.find(x=>x.id==id);
      if(!d) return;
      debtModalTitle.textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¯ÙŠÙ†';
      document.getElementById('debtCustomer').value = d.customer;
      document.getElementById('debtAmount').value = d.amount;
      document.getElementById('debtDue').value = d.dueDate;
      document.getElementById('debtNote').value = d.note || '';
      editingDebtId.value = d.id;
      debtModal.show();
    }

    /* ---------- ØªØµØ¯ÙŠØ± CSV ---------- */
    exportCsvBtn.addEventListener('click', ()=>{
      const debts = loadDebts();
      if(!debts.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±'); return; }
      const rows = [['id','customer','note','amount','dueDate','paid']];
      debts.forEach(d=> rows.push([d.id, d.customer.replace(/"/g,'""'), (d.note||'').replace(/"/g,'""'), d.amount, d.dueDate, d.paid]));
      const csv = rows.map(r => r.map(v=>`"${v}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'debts_export.csv'; a.click(); URL.revokeObjectURL(url);
    });

    /* ---------- Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙÙ„ØªØ± ---------- */
    searchInput.addEventListener('input', renderAll);
    filterSelect.addEventListener('change', renderAll);

    /* ---------- ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ---------- */
    document.addEventListener('DOMContentLoaded', ()=>{
      const s = getSession();
      if(s) showApp();
      else { loginView.style.display='block'; appView.style.display='none'; }
      // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± + Ù„Ùˆ Ù‡Ùˆ viewer
      const cur = getSession();
      if(cur && cur.role==='viewer') globalAddBtn.style.display='none';
      // ØªÙØ¹ÙŠÙ„ ÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ù…Ù† Ø²Ø± Ø§Ù„Ù€ + (Ù„Ùˆ admin)
      globalAddBtn.addEventListener('click', ()=>{
        const cur = getSession();
        if(!cur || cur.role!=='admin'){ alert('Ù…Ø§ Ø¹Ù†Ø¯Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø¥Ø¶Ø§ÙØ© Ø¯ÙŠÙ†'); return; }
        openAddModal('');
      });
    });

    // Ø¹Ø±Ø¶ Ø£Ùˆ Ø¥Ø®ÙØ§Ø¡ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ØµÙ„Ø§Ø­ÙŠØ©
    manageUsersBtn.addEventListener('click', ()=> {
      if(getSession().role!=='admin'){ alert('ØºÙŠØ± Ù…ØµØ±Ø­'); return; }
      usersModal.show();
    });

    // ÙˆØ¸ÙŠÙØ© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ù€ overdue Ø¨Ø´ÙƒÙ„ Ø«Ø§Ø¨Øª (ØµÙØ± Ø³Ø§Ø¹Ø©)
    Date.prototype.toDateString = (function(orig){
      return function(){ return orig.call(this); }
    })(Date.prototype.toDateString);
  </script>
</body>
</html>